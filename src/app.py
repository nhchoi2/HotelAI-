import streamlit as st
import pandas as pd
import joblib
import numpy as np
import plotly.express as px
import matplotlib as plt


# 1. ì €ì¥ëœ ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ ë° ì¸ì½”ë” ë¡œë“œ
try:
    model = joblib.load("models/random_forest.pkl")    # Random Forest ëª¨ë¸ ë¡œë“œ
    encoder = joblib.load("models/encoder.pkl")         # OneHotEncoder ê°ì²´ ë¡œë“œ (ì§€ì—­ëª…, ìˆ™ë°•ìœ í˜•ëª… ëŒ€ìƒ)
except Exception as e:
    st.error(f"ëª¨ë¸ ë˜ëŠ” ì¸ì½”ë” ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

tab1, tab2 = st.tabs(["ì˜ˆì¸¡", "ì§€ë„ ì‹œê°í™”"])

with tab1:
    st.header("ì˜ˆì¸¡ í˜ì´ì§€")
    # ì˜ˆì¸¡ ê´€ë ¨ UI ìš”ì†Œ ë°°ì¹˜


    city = ['ê°•ì›ë„ ê°•ë¦‰ì‹œ', 'ê°•ì›ë„ ê³ ì„±êµ°', 'ê°•ì›ë„ ë™í•´ì‹œ', 'ê°•ì›ë„ ì‚¼ì²™ì‹œ', 'ê°•ì›ë„ ì†ì´ˆì‹œ', 'ê°•ì›ë„ ì–‘êµ¬êµ°',
            'ê°•ì›ë„ ì–‘ì–‘êµ°', 'ê°•ì›ë„ ì˜ì›”êµ°', 'ê°•ì›ë„ ì›ì£¼ì‹œ', 'ê°•ì›ë„ ì¸ì œêµ°', 'ê°•ì›ë„ ì •ì„ êµ°', 'ê°•ì›ë„ ì² ì›êµ°',
            'ê°•ì›ë„ ì¶˜ì²œì‹œ', 'ê°•ì›ë„ íƒœë°±ì‹œ', 'ê°•ì›ë„ í‰ì°½êµ°', 'ê°•ì›ë„ í™ì²œêµ°', 'ê°•ì›ë„ í™”ì²œêµ°', 'ê°•ì›ë„ íš¡ì„±êµ°',
            'ê²½ê¸°ë„ ê°€í‰êµ°', 'ê²½ê¸°ë„ ê³ ì–‘ì‹œë•ì–‘êµ¬', 'ê²½ê¸°ë„ ê³ ì–‘ì‹œì¼ì‚°ë™êµ¬', 'ê²½ê¸°ë„ ê³ ì–‘ì‹œì¼ì‚°ì„œêµ¬', 'ê²½ê¸°ë„ ê³¼ì²œì‹œ',
            'ê²½ê¸°ë„ ê´‘ëª…ì‹œ', 'ê²½ê¸°ë„ ê´‘ì£¼ì‹œ', 'ê²½ê¸°ë„ êµ¬ë¦¬ì‹œ', 'ê²½ê¸°ë„ êµ°í¬ì‹œ', 'ê²½ê¸°ë„ ê¹€í¬ì‹œ', 'ê²½ê¸°ë„ ë‚¨ì–‘ì£¼ì‹œ',
            'ê²½ê¸°ë„ ë™ë‘ì²œì‹œ', 'ê²½ê¸°ë„ ë¶€ì²œì‹œ', 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œë¶„ë‹¹êµ¬', 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œìˆ˜ì •êµ¬', 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œì¤‘ì›êµ¬',
            'ê²½ê¸°ë„ ìˆ˜ì›ì‹œê¶Œì„ êµ¬', 'ê²½ê¸°ë„ ìˆ˜ì›ì‹œì˜í†µêµ¬', 'ê²½ê¸°ë„ ìˆ˜ì›ì‹œì¥ì•ˆêµ¬', 'ê²½ê¸°ë„ ìˆ˜ì›ì‹œíŒ”ë‹¬êµ¬', 'ê²½ê¸°ë„ ì‹œí¥ì‹œ',
            'ê²½ê¸°ë„ ì•ˆì‚°ì‹œë‹¨ì›êµ¬', 'ê²½ê¸°ë„ ì•ˆì‚°ì‹œìƒë¡êµ¬', 'ê²½ê¸°ë„ ì•ˆì„±ì‹œ', 'ê²½ê¸°ë„ ì•ˆì–‘ì‹œë™ì•ˆêµ¬', 'ê²½ê¸°ë„ ì•ˆì–‘ì‹œë§Œì•ˆêµ¬',
            'ê²½ê¸°ë„ ì–‘ì£¼ì‹œ', 'ê²½ê¸°ë„ ì–‘í‰êµ°', 'ê²½ê¸°ë„ ì—¬ì£¼ì‹œ', 'ê²½ê¸°ë„ ì—°ì²œêµ°', 'ê²½ê¸°ë„ ì˜¤ì‚°ì‹œ',
            'ê²½ê¸°ë„ ìš©ì¸ì‹œê¸°í¥êµ¬', 'ê²½ê¸°ë„ ìš©ì¸ì‹œìˆ˜ì§€êµ¬', 'ê²½ê¸°ë„ ìš©ì¸ì‹œì²˜ì¸êµ¬', 'ê²½ê¸°ë„ ì˜ì™•ì‹œ', 'ê²½ê¸°ë„ ì˜ì •ë¶€ì‹œ',
            'ê²½ê¸°ë„ ì´ì²œì‹œ', 'ê²½ê¸°ë„ íŒŒì£¼ì‹œ', 'ê²½ê¸°ë„ í‰íƒì‹œ']

    # 2. Streamlit UI ì„¤ì •
    st.title("ğŸ¨ ì§€ì—­ë³„ ì˜ˆìƒ ìˆ™ë°• ê°€ê²© ì˜ˆì¸¡")

    # 3. ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
    regions = city
    types = ["Hotel", "Pension", "Motel"]

    # ì„±ìˆ˜ê¸° ì—¬ë¶€ë¥¼ ìˆ«ìë¡œ ì„ íƒ (1: ì„±ìˆ˜ê¸°, 0: ë¹„ìˆ˜ê¸°) - UIì—ì„œëŠ” í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
    selected_season = st.selectbox("ì„±ìˆ˜ê¸° ì—¬ë¶€ë¥¼ ì„ íƒí•˜ì„¸ìš”", [1, 0],
                                format_func=lambda x: "ì„±ìˆ˜ê¸°" if x == 1 else "ë¹„ìˆ˜ê¸°")
    selected_region = st.selectbox("ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”", regions)
    selected_type = st.selectbox("ìˆ™ë°• ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”", types)

    # 4. ì˜ˆì¸¡ ë²„íŠ¼ í´ë¦­ ì‹œ ì˜ˆì¸¡ ìˆ˜í–‰
    if st.button("ì˜ˆì¸¡í•˜ê¸°"):
        try:
            # ì…ë ¥ ë°ì´í„°ë¥¼ DataFrameìœ¼ë¡œ ìƒì„± (ì„¸ ì»¬ëŸ¼ ëª¨ë‘ í¬í•¨)
            input_data = pd.DataFrame([[selected_region, selected_type, selected_season]], 
                                    columns=["ì§€ì—­ëª…", "ìˆ™ë°•ìœ í˜•ëª…", "ì„±ìˆ˜ê¸°ì—¬ë¶€"])
            # One-Hot Encoding ì ìš©: 'ì§€ì—­ëª…'ê³¼ 'ìˆ™ë°•ìœ í˜•ëª…'ì— ëŒ€í•´ ì¸ì½”ë”©
            X_transformed = encoder.transform(input_data[["ì§€ì—­ëª…", "ìˆ™ë°•ìœ í˜•ëª…"]])
            # ë§Œì•½ ì¸ì½”ë”© ê²°ê³¼ê°€ sparse matrixì´ë©´ dense arrayë¡œ ë³€í™˜
            if hasattr(X_transformed, "toarray"):
                X_transformed = X_transformed.toarray()
            # ìµœì¢… ì…ë ¥ ë°ì´í„° ìƒì„±: ì¸ì½”ë”©ëœ ë°ì´í„°ì™€ 'ì„±ìˆ˜ê¸°ì—¬ë¶€'ë¥¼ ê²°í•©
            final_input = np.hstack([X_transformed, input_data[["ì„±ìˆ˜ê¸°ì—¬ë¶€"]].values])
        
            # ì˜ˆì¸¡ ìˆ˜í–‰
            prediction = model.predict(final_input)[0]
            
            # ì˜ˆì¸¡ ê²°ê³¼ ì¶œë ¥
            st.success(f"ì˜ˆìƒ ìˆ™ë°• ê°€ê²©: {int(prediction)} ì›")

            # ë°ì´í„° ë¡œë“œ (CSV íŒŒì¼ì—ì„œ ë¡œë“œí•˜ëŠ” ì˜ˆì‹œ)
            df_price = pd.read_csv("data/raw/price.csv")

            # ì²« ë²ˆì§¸ ì¡°ê±´: "Hotel", "ê°•ì›ë„ ê°•ë¦‰ì‹œ", ì„±ìˆ˜ê¸°(1)
            filtered_data_1 = df_price[(df_price['ìˆ™ë°•ìœ í˜•ëª…'] == 'Hotel') & 
                                    (df_price['ì§€ì—­ëª…'] == 'ê°•ì›ë„ ê°•ë¦‰ì‹œ') & 
                                    (df_price['ì„±ìˆ˜ê¸°ì—¬ë¶€'] == 1)]

            # ë‘ ë²ˆì§¸ ì¡°ê±´: "Hotel", "ê°•ì›ë„ ê°•ë¦‰ì‹œ", ë¹„ìˆ˜ê¸°(0)
            filtered_data_2 = df_price[(df_price['ìˆ™ë°•ìœ í˜•ëª…'] == 'Hotel') & 
                                    (df_price['ì§€ì—­ëª…'] == 'ê°•ì›ë„ ê°•ë¦‰ì‹œ') & 
                                    (df_price['ì„±ìˆ˜ê¸°ì—¬ë¶€'] == 0)]

            # ì„±ìˆ˜ê¸° í†µê³„ê°’ ê³„ì‚°
            season_stats  = {
                "ìµœì†Œê°’": filtered_data_1['í‰ê· íŒë§¤ê¸ˆì•¡'].min(),
                "ìµœëŒ€ê°’": filtered_data_1['í‰ê· íŒë§¤ê¸ˆì•¡'].max(),
                "í‰ê· ê°’": int(filtered_data_1['í‰ê· íŒë§¤ê¸ˆì•¡'].mean())
            }

            # ë¹„ìˆ˜ê¸° í†µê³„ê°’ ê³„ì‚°
            off_season_stats  = {
                "ìµœì†Œê°’": filtered_data_2['í‰ê· íŒë§¤ê¸ˆì•¡'].min(),
                "ìµœëŒ€ê°’": filtered_data_2['í‰ê· íŒë§¤ê¸ˆì•¡'].max(),
                "í‰ê· ê°’": int(filtered_data_2['í‰ê· íŒë§¤ê¸ˆì•¡'].mean())
            }

            stats_df = pd.DataFrame({
                "ì„±ìˆ˜ê¸°/ë¹„ìˆ˜ê¸°": ["ì„±ìˆ˜ê¸°", "ë¹„ìˆ˜ê¸°"],
                "ìµœì†Œê°’": [season_stats["ìµœì†Œê°’"], off_season_stats["ìµœì†Œê°’"]],
                "ìµœëŒ€ê°’": [season_stats["ìµœëŒ€ê°’"], off_season_stats["ìµœëŒ€ê°’"]],
                "í‰ê· ê°’": [season_stats["í‰ê· ê°’"], off_season_stats["í‰ê· ê°’"]],
            })


            # Streamlitì— ê²°ê³¼ ì¶œë ¥
            st.write("ğŸ“‹ ì„±ìˆ˜ê¸°/ë¹„ìˆ˜ê¸° ê°€ê²© í†µê³„:")
            st.dataframe(stats_df)


            df_prediction = pd.DataFrame({
                "ì§€ì—­": [selected_region],
                "ì„±ìˆ˜ê¸° ê°€ê²© ì˜ˆì¸¡": [season_stats["í‰ê· ê°’"]],
                "ë¹„ìˆ˜ê¸° ê°€ê²© ì˜ˆì¸¡": [off_season_stats["í‰ê· ê°’"]],
                "ì„ íƒëœ ì§€ì—­ ê°€ê²©": [prediction]
            })

            fig = px.bar(df_prediction, 
                x="ì§€ì—­", 
                y=["ì„±ìˆ˜ê¸° ê°€ê²© ì˜ˆì¸¡", "ë¹„ìˆ˜ê¸° ê°€ê²© ì˜ˆì¸¡", "ì„ íƒëœ ì§€ì—­ ê°€ê²©"],
                title=f"ğŸ“Š {selected_region} ì§€ì—­ë³„ ì„±ìˆ˜ê¸°/ë¹„ìˆ˜ê¸° í‰ê·  ê°€ê²© ë° ì˜ˆìƒ ê°€ê²©",
                barmode="group")  # ê·¸ë£¹í˜• ë§‰ëŒ€ ê·¸ë˜í”„ ì„¤ì •
            

            fig.update_layout(
                bargap=0.15,  # ë§‰ëŒ€ ê°„ì˜ ê°„ê²©
                bargroupgap=0.1,  # ê·¸ë£¹ ê°„ì˜ ê°„ê²©
                autosize=True,  # ìë™ í¬ê¸° ì¡°ì •
                xaxis_title="ì§€ì—­",  # xì¶• ë¼ë²¨
                yaxis_title="ê°€ê²©(ì›)",  # yì¶• ë¼ë²¨
                plot_bgcolor="rgba(240, 240, 240, 1)",  # ê·¸ë˜í”„ ë°°ê²½ìƒ‰ (ì—°í•œ íšŒìƒ‰)
                
                # ì¶• ê²©ìì„  ë° í…Œë‘ë¦¬ ì„¤ì •
                xaxis=dict(
                    showgrid=True,  # xì¶•ì— ê²©ìì„  í‘œì‹œ
                    zeroline=True,  # xì¶•ì—ì„œ 0ë¼ì¸ í‘œì‹œ
                    showline=True,  # xì¶•ì— í…Œë‘ë¦¬ ì„  í‘œì‹œ
                    linecolor="black",  # xì¶• í…Œë‘ë¦¬ ìƒ‰ìƒ
                ),
                yaxis=dict(
                    showgrid=True,  # yì¶•ì— ê²©ìì„  í‘œì‹œ
                    zeroline=True,  # yì¶•ì—ì„œ 0ë¼ì¸ í‘œì‹œ
                    showline=True,  # yì¶•ì— í…Œë‘ë¦¬ ì„  í‘œì‹œ
                    linecolor="black",  # yì¶• í…Œë‘ë¦¬ ìƒ‰ìƒ
                )
            )
            st.plotly_chart(fig)

            
            
        except Exception as e:
            st.error(f"ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")


with tab2:
    st.header("ì§€ë„ ì‹œê°í™” í˜ì´ì§€")
    from map_embed import embed_map
    # map_embed.pyì˜ embed_map í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì €ì¥ëœ HTML ì§€ë„ë¥¼ ì„ë² ë“œ
    embed_map(html_file="../notebooks/cluster_map_with_image.html", height=600)
